# 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Knowledge Garden 公開サイト

### 1.2 目的
個人的な学習メモとナレッジベースを管理するリポジトリの内容を、自動的に公開できるWebサイトとして構築する。運用しながらまとまったトピックについて自動的に公開される仕組みを提供する。

### 1.3 背景
- これまで非公開で管理していたナレッジベースを公開したい
- 継続的な運用を前提とし、Markdownファイルの追加・更新だけで自動的に公開される仕組みが必要
- 技術的なまとめ（topics）と日々のメモ（daily notes）を体系的に公開したい

### 1.4 対象ユーザー
- **主要ユーザー**: リポジトリ管理者（自分自身）
- **閲覧ユーザー**: 技術的な知識を探している一般ユーザー

## 2. 機能要件

### 2.1 コンテンツ表示機能

#### 2.1.1 トピック表示機能
- **FR-001**: `topics/` ディレクトリ内のMarkdownファイルを自動的に読み込み、一覧表示する
- **FR-002**: 各トピックの個別ページを表示する
- **FR-003**: トピックはタイトルでソートして表示する
- **FR-004**: トピックのタイトルは、frontmatterの`title`フィールド、またはMarkdownの最初のH1タグから自動取得する
- **FR-005**: トピックにタグ（frontmatterの`tags`）がある場合は表示する

#### 2.1.2 日次ノート表示機能
- **FR-006**: `daily/` ディレクトリ内のMarkdownファイルを自動的に読み込み、一覧表示する
- **FR-007**: 各日次ノートの個別ページを表示する
- **FR-008**: 日次ノートは日付順（新しい順）で表示する
- **FR-009**: 日次ノートのタイトルは、frontmatterの`title`フィールド、またはMarkdownの最初のH1タグ、またはファイル名から自動取得する

#### 2.1.3 ホームページ機能
- **FR-010**: トピックと日次ノートの概要を表示する
- **FR-011**: 最近のトピック（最大6件）を表示する
- **FR-012**: 最近の日次ノート（最大5件）を表示する
- **FR-013**: 各セクションから詳細ページへのリンクを提供する

### 2.2 Markdownレンダリング機能

#### 2.2.1 基本レンダリング
- **FR-014**: MarkdownファイルをHTMLに変換して表示する
- **FR-015**: コードブロックにシンタックスハイライトを適用する
- **FR-016**: 見出しにアンカーリンクを自動生成する

#### 2.2.2 画像表示機能
- **FR-017**: Markdown内の画像パス（`../img/`）を公開サイト用のパスに自動変換する（ベースパスに応じて調整）
- **FR-018**: HTMLタグで記述された画像も正しく表示する
- **FR-019**: ビルド時に`img/`ディレクトリを`public/img/`に自動コピーする

### 2.3 ナビゲーション機能

#### 2.3.1 グローバルナビゲーション
- **FR-020**: 全ページに共通のヘッダーを表示する
- **FR-021**: ヘッダーに「トピック」「日次ノート」「GitHub」へのリンクを提供する
- **FR-022**: ヘッダーは固定表示（sticky）で、スクロール時も常に表示される

#### 2.3.2 ページ内ナビゲーション
- **FR-023**: 個別ページから一覧ページに戻るリンクを提供する
- **FR-024**: 関連コンテンツへのリンクを表示する（将来拡張可能）

### 2.4 自動デプロイ機能

#### 2.4.1 CI/CD機能
- **FR-025**: GitHub Actionsを使用して自動ビルド・デプロイを実行する
- **FR-026**: `main`ブランチにプッシュされた際に自動的にビルド・デプロイを実行する
- **FR-027**: 手動でデプロイを実行できる（workflow_dispatch）
- **FR-028**: newtralize.comのサーバーまたは静的ホスティングサービスに自動デプロイする（デプロイ方法は決定事項に依存）

#### 2.4.2 ビルド機能
- **FR-029**: Markdownファイルを読み込んで静的HTMLを生成する
- **FR-030**: 画像アセットを適切な場所にコピーする
- **FR-031**: ビルドエラーが発生した場合はデプロイを停止する

## 3. 非機能要件

### 3.1 パフォーマンス要件
- **NFR-001**: ページの初回読み込み時間は3秒以内を目標とする
- **NFR-002**: 静的サイトとして配信するため、サーバーサイドの処理は不要
- **NFR-003**: 画像は適切に最適化する（将来拡張）

### 3.2 可用性要件
- **NFR-004**: ホスティング先の可用性に依存する（newtralize.comのサーバーまたは選択したホスティングサービス）
- **NFR-005**: デプロイ失敗時は前回の正常なビルドを維持する

### 3.3 保守性要件
- **NFR-006**: 既存のMarkdownファイル構造を変更せずに動作する
- **NFR-007**: 新しいMarkdownファイルを追加するだけで自動的に反映される
- **NFR-008**: コードはTypeScript/Astroで記述し、型安全性を確保する
- **NFR-009**: **可能な限り標準構成を優先する**（カスタムコードは最小限に抑える）
  - Astroの標準機能（Content Collections、組み込みのMarkdownレンダリングなど）を優先的に使用する
  - カスタム実装が必要な場合は、標準機能で代替できないか検討する
  - 標準機能を使用することで、保守性・アップグレード性・ドキュメントの充実度が向上する

### 3.4 セキュリティ要件
- **NFR-009**: 静的サイトのため、サーバーサイドの脆弱性リスクは低い
- **NFR-010**: 外部へのリンクは`rel="noopener noreferrer"`を付与する

### 3.5 互換性要件
- **NFR-011**: モダンブラウザ（Chrome、Firefox、Safari、Edgeの最新版）で動作する
- **NFR-012**: モバイルデバイスでも適切に表示される（レスポンシブデザイン）

## 4. UI/UX要件

### 4.1 デザイン要件
- **UX-001**: シンプルで読みやすいデザインを採用する
- **UX-002**: Tailwind CSSを使用してスタイリングする
- **UX-003**: ダークモード対応は将来拡張として検討（現時点では未対応）

### 4.2 レイアウト要件
- **UX-004**: 最大幅を設定し、長文でも読みやすくする（max-width: 4xl相当）
- **UX-005**: 適切な余白と行間を設定する
- **UX-006**: Markdownコンテンツは適切にスタイリングする（見出し、リスト、コードブロックなど）

### 4.3 アクセシビリティ要件
- **UX-007**: セマンティックなHTMLを使用する
- **UX-008**: 適切なコントラスト比を確保する
- **UX-009**: キーボードナビゲーションに対応する（基本的なHTML要素の標準動作）

## 5. 技術要件

### 5.0 設計方針

#### 5.0.1 標準構成の優先
- **DESIGN-001**: **可能な限り標準構成を優先する方針を採用する**
  - Astroの標準機能（Content Collections、組み込みのMarkdownレンダリング、型定義の自動生成など）を優先的に使用する
  - カスタムコード（独自のユーティリティ関数、カスタムレンダラーなど）は最小限に抑える
  - 標準機能で実現できない場合のみ、カスタム実装を検討する

**理由**:
- **保守性**: 標準機能はAstroのアップデートに追従しやすく、長期的な保守が容易
- **ドキュメント**: 標準機能は公式ドキュメントが充実しており、学習コストが低い
- **コミュニティ**: 標準機能はコミュニティのサポートが受けやすく、問題解決が容易
- **型安全性**: Content Collectionsを使用することで、TypeScriptの型定義が自動生成され、型安全性が向上
- **パフォーマンス**: 標準機能は最適化されており、パフォーマンス面でも有利

**実装例**:
- Content Collectionsを使用することで、`gray-matter`や`markdown-it`などのカスタムライブラリが不要になる
- Astroの組み込みMarkdownレンダリングを使用することで、カスタムレンダラーが不要になる
- 型定義は`.astro/content.d.ts`として自動生成されるため、手動での型定義が不要

### 5.1 技術スタック
- **TECH-001**: Astro 5.x を使用する（静的サイトジェネレーター）
  - 選定理由: 詳細は [ADR 0002: Astroを静的サイトジェネレーターとして採用](./adr/0002-use-astro-as-static-site-generator.md) を参照
  - Markdownのネイティブサポート、TypeScript完全対応、既存構造への適合性が高い
  - **標準機能の優先**: Content Collectionsを使用することで、カスタムコードを最小限に抑える
- **TECH-002**: TypeScript を使用する
- **TECH-003**: Tailwind CSS を使用する（スタイリング）
- **TECH-004**: **Content Collections**を使用する（標準機能）
  - 説明: Astroの標準機能で、Markdownファイルを型安全に管理する
  - 用途: `src/content/topics/`や`src/content/daily/`のMarkdownファイルを自動的に読み込み、型定義を生成
  - 機能: 
    - Zodスキーマによるfrontmatterの型定義とバリデーション
    - TypeScriptの型定義の自動生成（`.astro/content.d.ts`）
    - 組み込みのMarkdownレンダリング（カスタムレンダラー不要）
  - 実装: `src/content/config.ts`でコレクションを定義
  - **標準構成の優先**: `gray-matter`や`markdown-it`などのカスタムライブラリは不要

### 5.2 ホスティング
- **TECH-006**: 個人事業サイト `newtralize.com` のサブドメインで公開する
- **TECH-007**: サブドメイン方式を採用: `https://knowledge.newtralize.com`
- **TECH-007-1**: ベースパスは `/`（サブドメインのため）
- **TECH-007-2**: 詳細は [ADR 0001: Knowledge Gardenのサブドメイン方式採用](./adr/0001-use-subdomain-for-knowledge-garden.md) を参照
- **TECH-007-3**: 決定日: 2025年1月

### 5.3 ビルド環境
- **TECH-008**: Node.js 20以上が必要
- **TECH-009**: npm を使用する（パッケージマネージャー）

### 5.4 ファイル構造
- **TECH-010**: Astroの標準構成に従う
  - コンテンツ（Markdownファイル）は`src/content/`ディレクトリに配置する（Content Collectionsの標準）
  - 静的アセットは`public/`ディレクトリに配置する（Astroの標準）
- **TECH-011**: Astroのソースコードは`src/`ディレクトリに配置する
  - `src/pages/`: ページコンポーネント
  - `src/layouts/`: レイアウトコンポーネント
  - `src/content/`: コンテンツ（Markdownファイル）
- **TECH-012**: 静的アセットは`public/`ディレクトリに配置する（Astroの標準構成）

### 5.5 ライブラリの詳細説明

#### 5.5.1 Content Collections（TECH-004）

**概要**: Astroの標準機能で、Markdownファイルを型安全に管理するシステム

**主な機能**:
- Zodスキーマによるfrontmatterの型定義とバリデーション
- TypeScriptの型定義の自動生成（`.astro/content.d.ts`）
- 組み込みのMarkdownレンダリング（カスタムレンダラー不要）
- `getCollection()` APIでコレクションを取得
- `<Content />`コンポーネントでMarkdownを自動レンダリング

**使用例**:
```typescript
// src/content/config.ts
import { defineCollection, z } from 'astro:content';

const topics = defineCollection({
  type: 'content',
  schema: z.object({
    title: z.string().optional(),
    date: z.string().optional(),
    tags: z.array(z.string()).optional(),
  }),
});

export const collections = { topics };
```

```astro
---
// src/pages/topics/index.astro
import { getCollection } from 'astro:content';

const topics = await getCollection('topics');
---
```

**実装場所**: `src/content/config.ts`

**標準構成の優先**:
- 以前は`gray-matter`と`markdown-it`を使用したカスタム実装を使用していたが、Content Collectionsに移行することで、これらのライブラリが不要になった
- 標準機能を使用することで、保守性・型安全性・ドキュメントの充実度が向上

## 6. 運用要件

### 6.1 コンテンツ管理
- **OP-001**: Markdownファイルの追加・更新は通常のGitワークフローで行う
- **OP-002**: ファイルをコミット・プッシュするだけで自動的に公開される
- **OP-003**: デプロイには数分かかる場合があることを理解する

### 6.2 監視・確認
- **OP-004**: GitHub Actionsのログでデプロイ状況を確認できる
- **OP-005**: ローカルで`npm run dev`してプレビューできる
- **OP-006**: ビルドエラーはGitHub Actionsのログで確認できる

### 6.3 バックアップ
- **OP-007**: コンテンツはGitリポジトリで管理されるため、GitHubがバックアップとして機能する

## 7. 制約事項

### 7.1 技術的制約
- **CONST-001**: 静的サイトのみ対応（サーバーサイド処理は不要）
- **CONST-002**: ベースパスに応じて、すべてのリンクとアセットパスを適切に設定する必要がある
- **CONST-003**: 画像パスは相対パス（`../img/`）から絶対パスへの変換が必要（ベースパスに応じて調整）

### 7.2 運用上の制約
- **CONST-004**: デプロイはGitHub Actionsの実行時間に依存する（通常数分）
- **CONST-005**: 一度に大量のファイルを追加した場合、ビルド時間が長くなる可能性がある

## 8. 将来拡張の検討事項

### 8.1 機能拡張
- **FUTURE-001**: 検索機能の追加
- **FUTURE-002**: タグによるフィルタリング機能
- **FUTURE-003**: RSSフィードの生成
- **FUTURE-004**: サイトマップの自動生成
- **FUTURE-005**: ダークモード対応
- **FUTURE-006**: 関連トピックの自動表示
- **FUTURE-007**: コメント機能（外部サービス連携）

### 8.2 コンテンツ拡張
- **FUTURE-008**: `snippets/`ディレクトリのコンテンツも公開する
- **FUTURE-009**: カテゴリ別の分類機能

## 9. 成功基準

### 9.1 機能的な成功基準
- ✅ `topics/`内のMarkdownファイルがすべて一覧表示される
- ✅ `daily/`内のMarkdownファイルがすべて一覧表示される
- ✅ 各Markdownファイルの個別ページが正しく表示される
- ✅ 画像が正しく表示される
- ✅ GitHub Actionsで自動デプロイが成功する

### 9.2 運用上の成功基準
- ✅ Markdownファイルを追加するだけで自動的に公開される
- ✅ 既存のワークフローを変更せずに運用できる
- ✅ ローカルでプレビューしてから公開できる

## 10. リスクと対策

### 10.1 技術的リスク
- **RISK-001**: ビルドエラーが発生する可能性
  - **対策**: ローカルでビルドを確認してからプッシュする
- **RISK-002**: 画像パスの変換が正しく動作しない可能性
  - **対策**: 正規表現による変換ロジックをテストする

### 10.2 運用上のリスク
- **RISK-003**: デプロイが失敗する可能性
  - **対策**: GitHub Actionsのログを確認し、エラーを修正する
- **RISK-004**: 大量のコンテンツ追加でビルド時間が長くなる
  - **対策**: 必要に応じてビルド最適化を検討する

## 11. 用語集

- **トピック**: `topics/`ディレクトリ内の技術的なまとめを記述したMarkdownファイル
- **日次ノート**: `daily/`ディレクトリ内の日々のメモを記述したMarkdownファイル
- **frontmatter**: Markdownファイルの先頭に記述されるYAML形式のメタデータ
- **ベースパス**: サイトのルートパス（決定したドメイン構造に応じて設定。例: `/knowledge`、`/knowledge-garden`、またはサブドメインの場合は `/`）
- **newtralize.com**: 個人事業サイトのメインドメイン

