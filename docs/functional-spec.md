# 機能仕様書

## 1. システム概要

Knowledge Garden公開サイトは、Markdownファイルで管理されたナレッジベースを自動的にWebサイトとして公開するシステムです。

**URL**: `https://knowledge.newtralize.com`（サブドメイン方式）  
**ベースパス**: `/`（サブドメインのため）

## 2. 機能一覧

### 2.1 ページ構成

| ページ | パス | 説明 |
|--------|------|------|
| ホーム | `/` | トピックと日次ノートの概要を表示 |
| トピック一覧 | `/topics` | すべてのトピックを一覧表示 |
| トピック詳細 | `/topics/[slug]` | 個別トピックの詳細ページ |
| 日次ノート一覧 | `/daily` | すべての日次ノートを一覧表示 |
| 日次ノート詳細 | `/daily/[slug]` | 個別日次ノートの詳細ページ |

**注**: サブドメイン方式（`knowledge.newtralize.com`）を採用しているため、ベースパスは `/` です。

### 2.2 データフロー

```
Markdownファイル (src/content/topics/*.md, src/content/daily/*.md)
    ↓
ユーティリティ関数 (getTopics, getDailyNotes)
    ↓
ページコンポーネント (Astro)
    ↓
Markdownレンダリング (markdown-it)
    ↓
HTML生成
    ↓
静的サイト (dist/)
    ↓
Dockerイメージ (ビルド)
    ↓
Xserver VPS (Traefik + Docker)
```

## 3. 詳細機能仕様

### 3.1 トピック表示機能

#### 3.1.1 トピック一覧ページ

**機能**: `src/content/topics/`ディレクトリ内のすべてのMarkdownファイルを読み込み、一覧表示する

**入力**:
- `src/content/topics/`ディレクトリ内の`.md`ファイル

**処理**:
1. `src/content/topics/`ディレクトリをスキャン
2. 各`.md`ファイルを読み込み
3. frontmatterを解析（gray-matter）
4. タイトルを取得（frontmatterの`title`、または最初のH1、またはファイル名）
5. タイトルでソート（日本語対応）
6. 各トピックのプレビューテキストを生成（最初の150文字）

**出力**:
- トピックカードのグリッド表示
- 各カードにタイトル、プレビューテキスト、リンクを含む

**表示形式**:
```
┌─────────────────────────────────────┐
│ トピック一覧                        │
├─────────────────────────────────────┤
│ [カード1] [カード2] [カード3]      │
│ [カード4] [カード5] [カード6]      │
│ ...                                 │
└─────────────────────────────────────┘
```

#### 3.1.2 トピック詳細ページ

**機能**: 個別トピックの完全な内容を表示する

**入力**:
- URLパラメータ: `slug`（ファイル名から`.md`を除いたもの）

**処理**:
1. `src/content/topics/[slug].md`ファイルを読み込み
2. frontmatterとコンテンツを分離
3. MarkdownをHTMLに変換（画像パスは既に `/img/` 形式で記述されている）
4. シンタックスハイライトを適用

**出力**:
- タイトル
- タグ（存在する場合）
- レンダリングされたHTMLコンテンツ
- 一覧ページへの戻るリンク

**表示形式**:
```
┌─────────────────────────────────────┐
│ [タイトル]                          │
│ [タグ1] [タグ2]                     │
├─────────────────────────────────────┤
│                                     │
│ [Markdownコンテンツ]                │
│                                     │
├─────────────────────────────────────┤
│ ← トピック一覧に戻る                │
└─────────────────────────────────────┘
```

### 3.2 日次ノート表示機能

#### 3.2.1 日次ノート一覧ページ

**機能**: `src/content/daily/`ディレクトリ内のすべてのMarkdownファイルを読み込み、一覧表示する

**入力**:
- `src/content/daily/`ディレクトリ内の`.md`ファイル

**処理**:
1. `src/content/daily/`ディレクトリをスキャン
2. 各`.md`ファイルを読み込み
3. frontmatterを解析
4. タイトルを取得（frontmatterの`title`、または最初のH1、またはファイル名）
5. 日付順でソート（新しい順）
6. ファイル名から日付を抽出（`YYYY-MM-DD.md`形式を想定）

**出力**:
- 日次ノートのリスト表示
- 各項目にタイトル、日付、リンクを含む

**表示形式**:
```
┌─────────────────────────────────────┐
│ 日次ノート一覧                      │
├─────────────────────────────────────┤
│ [タイトル1]          2025-08-09      │
│ [タイトル2]          2025-08-08      │
│ [タイトル3]          2025-08-07      │
│ ...                                 │
└─────────────────────────────────────┘
```

#### 3.2.2 日次ノート詳細ページ

**機能**: 個別日次ノートの完全な内容を表示する

**入力**:
- URLパラメータ: `slug`（ファイル名から`.md`を除いたもの）

**処理**:
1. `src/content/daily/[slug].md`ファイルを読み込み
2. frontmatterとコンテンツを分離
3. MarkdownをHTMLに変換（画像パスは既に `/img/` 形式で記述されている）
4. シンタックスハイライトを適用

**出力**:
- タイトル
- 日付
- レンダリングされたHTMLコンテンツ
- 一覧ページへの戻るリンク

### 3.3 ホームページ機能

**機能**: サイトの概要と最近のコンテンツを表示する

**処理**:
1. トピック一覧から最新6件を取得
2. 日次ノート一覧から最新5件を取得
3. 各セクションを表示

**表示形式**:
```
┌─────────────────────────────────────┐
│ Knowledge Garden                    │
│ 個人的な学習メモとナレッジベース... │
├─────────────────────────────────────┤
│ トピック              [すべて見る→] │
│ [カード1] [カード2] [カード3]      │
│ [カード4] [カード5] [カード6]      │
├─────────────────────────────────────┤
│ 最近の日次ノート      [すべて見る→] │
│ [ノート1] 2025-08-09                │
│ [ノート2] 2025-08-08                │
│ ...                                 │
└─────────────────────────────────────┘
```

### 3.4 Markdownレンダリング機能

#### 3.4.1 基本変換

**処理**:
1. Markdown-itを使用してMarkdownをHTMLに変換
2. HTMLタグを許可（`html: true`）
3. リンクを自動的にリンク化（`linkify: true`）
4. タイポグラフィを改善（`typographer: true`）

#### 3.4.2 画像パス変換

**処理**:
1. Markdownファイル内では画像パスを `/img/` から始まる絶対パスで記述する（例: `/img/screenshots/image.png`）
2. Astroの標準構成に従い、`public/img/` に配置された画像がそのまま配信される
3. パス変換は不要（Markdownファイル内で既に正しいパスで記述されている）

#### 3.4.3 シンタックスハイライト

**処理**:
1. AstroのShiki統合を使用
2. テーマ: `github-dark`
3. コードブロックを自動的にハイライト

#### 3.4.4 見出しアンカー

**処理**:
1. markdown-it-anchorを使用
2. 各見出しに自動的にアンカーリンクを生成
3. クリック可能なリンクアイコンを表示

### 3.5 ナビゲーション機能

#### 3.5.1 グローバルヘッダー

**表示内容**:
- サイトタイトル（Knowledge Garden）: ホームへのリンク
- トピック: トピック一覧へのリンク
- 日次ノート: 日次ノート一覧へのリンク
- GitHub: リポジトリへのリンク（外部リンク）

**動作**:
- ページ上部に固定表示（sticky）
- スクロール時も常に表示される
- ホバー時に色が変わる

#### 3.5.2 ページ内ナビゲーション

**表示内容**:
- 個別ページのフッターに「一覧に戻る」リンクを表示

### 3.6 自動デプロイ機能

#### 3.6.1 GitHub Actionsワークフロー

**ホスティング**: Xserver VPS（Traefik + Docker構成）

**トリガー**:
- `main`ブランチへのプッシュ
- 手動実行（workflow_dispatch）

**処理フロー**:
```
1. リポジトリをチェックアウト
2. Docker Buildxをセットアップ
3. Docker Hubにログイン
4. Dockerイメージをビルド（内部でnpm ci、ビルド、アセットコピーを実行）
5. Docker Hubにプッシュ
6. Xserver VPSにSSH接続
7. このリポジトリのディレクトリに移動
8. リポジトリを最新化（git pull）
9. docker-compose pull & up を実行
10. Traefikが自動的にルーティング設定
```

**デプロイ方法**:
- GitHub ActionsでDockerイメージをビルド・プッシュ
- VPSにSSH接続して、このリポジトリのディレクトリでコンテナを更新
- このリポジトリのみでデプロイが完結（infra-opsリポジトリへの依存なし）
- Traefikが自動的にルーティングを設定

**必要な設定**:
- GitHub Secrets:
  - `DOCKER_USERNAME`: Docker Hubのユーザー名
  - `DOCKER_PASSWORD`: Docker Hubのパスワード
  - `VPS_HOST`: VPSのIPアドレスまたはホスト名
  - `VPS_USER`: SSHユーザー名
  - `VPS_SSH_KEY`: SSH秘密鍵
  - `KNOWLEDGE_GARDEN_PATH`: このリポジトリをクローンしたVPS上のパス（例: `/opt/knowledge-garden`）

**前提条件**:
- VPSにこのリポジトリをクローン済み（初回のみ手動で実行）
- Traefikが既に動作している
- Dockerネットワーク（`traefik`）がTraefikによって作成済み

**エラーハンドリング**:
- ビルドエラーが発生した場合、デプロイを停止
- 前回の正常なビルドを維持（既存のコンテナが動作し続ける）
- SSH接続エラーの場合は、ログで確認可能

**注意事項**:
- 初回は手動でVPSにSSH接続してリポジトリをクローンすることを推奨
- Traefikのネットワーク設定（`traefik`）を確認
- `docker-compose.yml`は`image`を使用（本番環境用）
- ローカル開発時は `compose.override.yaml`（自動読込）を使用（`build` を使用）

## 4. データ構造

### 4.1 トピックデータ構造

```typescript
interface Topic {
  slug: string;           // ファイル名から.mdを除いたもの
  title: string;          // 表示タイトル
  content: string;        // Markdownコンテンツ（frontmatter除く）
  data: {
    title?: string;       // frontmatterのtitle
    date?: string;        // frontmatterのdate
    tags?: string[];      // frontmatterのtags
  };
}
```

### 4.2 日次ノートデータ構造

```typescript
interface DailyNote {
  slug: string;           // ファイル名から.mdを除いたもの
  title: string;          // 表示タイトル
  content: string;        // Markdownコンテンツ（frontmatter除く）
  date: string;           // 日付（frontmatterのdate、またはファイル名）
}
```

## 5. UIコンポーネント仕様

### 5.1 レイアウトコンポーネント

**BaseLayout.astro**
- 共通のHTML構造を提供
- ヘッダー、メインコンテンツ、フッターを含む
- メタタグ、タイトルを設定
- グローバルスタイルを定義

### 5.2 スタイリング

**Tailwind CSSクラス**:
- コンテナ: `max-w-4xl mx-auto px-4`
- カード: `bg-white rounded-lg border border-gray-200 hover:border-blue-500`
- タイポグラフィ: `text-3xl font-bold`（H1）、`text-2xl font-bold`（H2）など

**Markdownコンテンツスタイル**:
- 見出し: 適切なサイズとマージン
- コードブロック: ダークテーマ、スクロール可能
- リスト: 適切なインデント
- リンク: 青色、ホバー時に下線

## 6. エラーハンドリング

### 6.1 ファイル読み込みエラー

**ケース**: ファイルが存在しない、読み込みに失敗した

**処理**:
- 404ページを表示（将来実装）
- または一覧から除外

### 6.2 ビルドエラー

**ケース**: Markdownの構文エラー、TypeScriptエラーなど

**処理**:
- エラーメッセージをログに出力
- デプロイを停止
- GitHub Actionsのログで確認可能

## 7. パフォーマンス最適化

### 7.1 静的生成

- すべてのページをビルド時に事前生成
- ランタイムの処理は不要

### 7.2 画像最適化

- 現時点では最適化なし（将来拡張可能）
- 適切なサイズの画像を使用することを推奨

## 8. セキュリティ考慮事項

### 8.1 XSS対策

- Markdown-itのデフォルト設定でHTMLをサニタイズ
- ただし、`html: true`によりHTMLタグは許可（コンテンツ作成者が信頼できるため）

### 8.2 外部リンク

- 外部リンクには`rel="noopener noreferrer"`を付与
- `target="_blank"`を使用する場合は必ず`rel`属性を設定

## 9. テスト要件

### 9.1 手動テスト項目

- [ ] トピック一覧が正しく表示される
- [ ] トピック詳細ページが正しく表示される
- [ ] 日次ノート一覧が正しく表示される
- [ ] 日次ノート詳細ページが正しく表示される
- [ ] 画像が正しく表示される
- [ ] ナビゲーションリンクが正しく動作する
- [ ] レスポンシブデザインが正しく動作する
- [ ] GitHub Actionsでビルドが成功する
- [ ] デプロイが成功する

### 9.2 自動テスト（将来拡張）

- ユニットテスト（Markdown変換ロジック）
- E2Eテスト（主要なページ遷移）

